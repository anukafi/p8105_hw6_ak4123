---
title: "p8105_hw6_ak4123"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
set.seed(1)
```

Create a city_state variable (e.g. “Baltimore, MD”), and a binary variable indicating whether the homicide is solved. Omit cities Dallas, TX; Phoenix, AZ; and Kansas City, MO – these don’t report victim race. Also omit Tulsa, AL – this is a data entry mistake. 
``` {r}
homicides = read.csv("./data/homicide-data.csv")

homicides = homicides %>% 
  mutate(city_state = paste(city, state, sep = ", "),
         resolution = as.numeric(disposition == "Closed by arrest"),
         victim_race_binary = case_when(
           victim_race == "Asian" ~ "Non-White",
           victim_race == "Black" ~ "Non-White",
           victim_race == "Hispanic" ~ "Non-White",
           victim_race == "Other" ~ "Non-White",
           victim_race == "Unknown" ~ "Non-White",
           victim_race == "White" ~ "White"
         ),
         victim_race = factor(victim_race_binary, levels = c("White", "Non-White")),
         victim_age = as.numeric(as.character(victim_age))
  ) %>% 
  filter(city_state != "Dallas, TX" & city_state != "Phoenix, AZ" & city_state != "Kansas City, MO" & city_state != "Tulsa, AL")
```

For the city of Baltimore, MD, use the glm function to fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race (as just defined) as predictors. Save the output of glm as an R object; apply the broom::tidy to this object; and obtain the estimate and confidence interval of the adjusted odds ratio for solving homicides comparing non-white victims to white victims keeping all other variables fixed.

```{r} 
logistic = 
  homicides %>% 
  filter(city_state == "Baltimore, MD") %>% 
  glm(resolution ~ victim_age + victim_sex + victim_race, data = ., family = binomial())
logistic %>% 
  broom::tidy() %>% 
  janitor::clean_names() %>% 
  mutate(OR = exp(estimate),
         lower_ci = exp(estimate - (1.96 * std_error)),
         upper_ci = exp(estimate + (1.96 * std_error))) %>%
  filter(term == "victim_raceNon-White") %>% 
  select(OR, lower_ci, upper_ci) %>% 
  knitr::kable()
```

Now run glm for each of the cities in your dataset, and extract the adjusted odds ratio (and CI) for solving homicides comparing non-white victims to white victims. Do this within a “tidy” pipeline, making use of purrr::map, list columns, and unnest as necessary to create a dataframe with estimated ORs and CIs for each city.

```{r}
logistic =
  homicides %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(models = map(data, ~lm(resolution ~ victim_age + victim_sex + victim_race, data = .x)),
         models = map(models, broom::tidy)) %>% 
  select(-data)

logistic = logistic %>% 
  unnest() %>% 
  janitor::clean_names() %>% 
  mutate(OR = exp(estimate),
         lower_ci = exp(estimate - (1.96 * std_error)),
         upper_ci = exp(estimate + (1.96 * std_error))) %>% 
  filter(term == "victim_raceNon-White") %>%
  select(city_state, OR, lower_ci, upper_ci) 
  
logistic %>% 
  knitr::kable()
```

```{r}
nest_glm_res =
  homicides %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(models = map(data, ~lm(resolution ~ victim_age + victim_sex + victim_race, data = .x)),
         models = map(models, broom::tidy)) %>% 
  select(-data)

glm_homicides = nest_glm_res %>% 
  unnest() %>% 
  janitor::clean_names() %>% 
  mutate(OR = exp(estimate),
         lower_ci = exp(estimate - (1.96 * std_error)),
         upper_ci = exp(estimate + (1.96 * std_error))
  ) %>% 
  filter(term == "victim_raceNon-White") %>%
  select(city_state, OR, lower_ci, upper_ci) 
  
glm_homicides %>% 
  knitr::kable()
```

```{r}
glm_homicides %>% 
  mutate(city_state = forcats::fct_inorder(city_state)) %>% 
  ggplot(aes(x = city_state, y = OR)) +
  geom_point() +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci)) +
  labs(
    x = "City, State",
    y = "ORs",
    title = "ORs and 95% CIs for Solved Cases Comparing Non-whites to Whites"
  ) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 5)) 
```
